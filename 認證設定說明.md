# Azure AD 認證設定說明

## 🔐 認證方式

服務現在支援兩種認證方式：

### 方式 1：Client Secret（推薦，更安全）

適合伺服器端應用程式，不需要使用者帳號密碼。

#### 步驟 1：在 Azure AD 中建立 Client Secret

1. 登入 [Azure Portal](https://portal.azure.com)
2. 進入 **Azure Active Directory** → **應用程式註冊**
3. 選擇你的應用程式（CLIENT_ID 對應的應用程式）
4. 進入 **憑證和祕密**（Certificates & secrets）
5. 點擊 **新增用戶端祕密**（New client secret）
6. 輸入描述（例如：Railway Proxy Server）
7. 選擇過期時間（建議選擇最長期限）
8. 點擊 **新增**
9. **重要**：立即複製 Secret 值（只會顯示一次！）

#### 步驟 2：在 Railway 中設定環境變數

1. 進入 Railway 專案
2. 選擇 `railway-proxy-server` 服務
3. 進入 **Variables** 標籤
4. 新增環境變數：
   - **名稱**: `CLIENT_SECRET`
   - **值**: 剛才複製的 Secret 值
5. 儲存變更

#### 步驟 3：確認環境變數

確保以下環境變數都已設定：
- ✅ `TENANT_ID`
- ✅ `CLIENT_ID`
- ✅ `CLIENT_SECRET`（新增）

**注意**：如果設定了 `CLIENT_SECRET`，就不需要 `PROXY_USERNAME` 和 `PROXY_PASSWORD` 了。

---

### 方式 2：UsernamePasswordCredential（需要公開客戶端設定）

如果不想使用 Client Secret，可以將應用程式設定為公開客戶端。

#### 步驟 1：將應用程式設定為公開客戶端

1. 登入 [Azure Portal](https://portal.azure.com)
2. 進入 **Azure Active Directory** → **應用程式註冊**
3. 選擇你的應用程式
4. 進入 **驗證**（Authentication）
5. 在 **進階設定**（Advanced settings）中：
   - 找到 **允許公開客戶端流程**（Allow public client flows）
   - 設定為 **是**（Yes）
6. 儲存變更

#### 步驟 2：確認環境變數

確保以下環境變數都已設定：
- ✅ `TENANT_ID`
- ✅ `CLIENT_ID`
- ✅ `PROXY_USERNAME`
- ✅ `PROXY_PASSWORD`

---

## 🧪 測試認證

設定完成後，等待 Railway 重新部署（約 1-2 分鐘），然後測試：

```bash
curl -X POST https://railway-proxy-server-production.up.railway.app/api/getStudentGrade \
  -H "Content-Type: application/json" \
  -d '{
    "studentId": "test_student",
    "excelFilePath": "https://groupespauloedu.sharepoint.com/:x:/s/Classrooms/ETkQTI8MIplOvwXs8M57LJ8Beka2YsoNxcu3EgIXv0LKsw?e=V3W25H"
  }'
```

如果認證成功，應該會看到：
- 成功：返回學生成績資料或「找不到學生資料」（表示檔案可以讀取）
- 失敗：返回認證錯誤訊息

## ⚠️ 常見問題

### Q1: 收到 "invalid_client" 錯誤

**原因**：應用程式未設定為公開客戶端，且未設定 CLIENT_SECRET。

**解決方案**：
- 選擇方式 1：設定 CLIENT_SECRET（推薦）
- 或選擇方式 2：將應用程式設定為公開客戶端

### Q2: 收到 "AADSTS7000218" 錯誤

**原因**：應用程式需要 client_secret 或 client_assertion。

**解決方案**：使用方式 1（Client Secret 認證）

### Q3: 忘記複製 Client Secret

**解決方案**：
1. 刪除舊的 Secret
2. 建立新的 Secret
3. 立即複製並設定到 Railway

## 📝 優先順序

服務會按照以下順序選擇認證方式：

1. **優先**：如果設定了 `CLIENT_SECRET`，使用 Client Secret 認證
2. **備選**：如果設定了 `PROXY_USERNAME` 和 `PROXY_PASSWORD`，使用 UsernamePasswordCredential
3. **錯誤**：如果兩者都沒有設定，會拋出錯誤

## 🔒 安全性建議

- ✅ **推薦使用 Client Secret**：更安全，不需要儲存使用者密碼
- ✅ 定期輪換 Client Secret（建議每 90 天）
- ✅ 不要在程式碼中硬編碼 Secret
- ✅ 使用環境變數管理敏感資訊
