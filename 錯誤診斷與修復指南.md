# Railway ä»£ç†æœå‹™éŒ¯èª¤è¨ºæ–·èˆ‡ä¿®å¾©æŒ‡å—

## ğŸ”´ éŒ¯èª¤è¨Šæ¯

```
ä»£ç†æœå‹™è¼‰å…¥å¤±æ•—: ä»£ç†æœå‹™éŒ¯èª¤ (500): General exception while processing
```

## ğŸ“‹ å•é¡Œåˆ†æ

é€™å€‹éŒ¯èª¤é€šå¸¸æ˜¯ç”±ä»¥ä¸‹åŸå› é€ æˆçš„ï¼š

1. **èªè­‰ Scope æ ¼å¼éŒ¯èª¤**ï¼ˆæœ€å¯èƒ½ï¼‰
   - ä½¿ç”¨ `ClientSecretCredential` æ™‚ï¼Œscope å¿…é ˆä½¿ç”¨ `/.default` æ ¼å¼
   - ç›®å‰ä»£ç¢¼å¯èƒ½ä»åœ¨ä½¿ç”¨èˆŠçš„æ ¼å¼

2. **ç’°å¢ƒè®Šæ•¸æœªæ­£ç¢ºè¨­å®š**
   - `CLIENT_SECRET` æˆ– `PROXY_USERNAME`/`PROXY_PASSWORD` æœªè¨­å®š
   - `TENANT_ID` æˆ– `CLIENT_ID` æœªè¨­å®š

3. **Excel æª”æ¡ˆè™•ç†éŒ¯èª¤**
   - æª”æ¡ˆè·¯å¾‘æ ¼å¼ä¸æ­£ç¢º
   - Graph API æ¬Šé™ä¸è¶³

## âœ… å·²ä¿®æ­£çš„ä»£ç¢¼

### 1. `src/auth.ts` - èªè­‰ Scope ä¿®æ­£

**å•é¡Œ**ï¼šä½¿ç”¨ `ClientSecretCredential` æ™‚ï¼Œscope æ ¼å¼ä¸æ­£ç¢º

**ä¿®æ­£**ï¼š
```typescript
async getAccessToken(): Promise<string> {
    try {
        const credential = this.getCredential();
        
        // Client Secret Credentialï¼ˆæ‡‰ç”¨ç¨‹å¼èªè­‰æµç¨‹ï¼‰å¿…é ˆä½¿ç”¨ /.default æ ¼å¼
        // UsernamePasswordCredentialï¼ˆå§”æ´¾èªè­‰æµç¨‹ï¼‰å¯ä»¥ä½¿ç”¨å…·é«”çš„æ¬Šé™ç¯„åœ
        const scopes = this.isClientSecretAuth
            ? ['https://graph.microsoft.com/.default']  // æ‡‰ç”¨ç¨‹å¼èªè­‰æµç¨‹
            : [  // å§”æ´¾èªè­‰æµç¨‹
                'https://graph.microsoft.com/Files.Read.All',
                'https://graph.microsoft.com/Sites.Read.All'
            ];
        
        console.log(`å–å¾—å­˜å–æ¬Šæ–ï¼Œèªè­‰é¡å‹: ${this.isClientSecretAuth ? 'Client Secret' : 'Username/Password'}`);
        console.log(`Scope: ${scopes.join(', ')}`);
        
        const response = await credential.getToken(scopes);
        
        if (!response || !response.token) {
            throw new Error('ç„¡æ³•å–å¾—å­˜å–æ¬Šæ–ï¼šå›æ‡‰ç‚ºç©º');
        }
        
        console.log('æˆåŠŸå–å¾—å­˜å–æ¬Šæ–');
        return response.token;
    } catch (error: any) {
        console.error('å–å¾—å­˜å–æ¬Šæ–æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        console.error('éŒ¯èª¤è©³æƒ…:', {
            message: error?.message,
            name: error?.name,
            code: error?.code,
            statusCode: error?.statusCode,
            errorCode: error?.errorCode,
            errorDescription: error?.errorDescription
        });
        
        // æä¾›æ›´è©³ç´°çš„éŒ¯èª¤è¨Šæ¯
        if (error?.message) {
            throw new Error(`èªè­‰å¤±æ•—: ${error.message}`);
        } else if (error?.errorCode) {
            throw new Error(`èªè­‰å¤±æ•— (${error.errorCode}): ${error.errorDescription || 'æœªçŸ¥éŒ¯èª¤'}`);
        } else {
            throw new Error(`èªè­‰å¤±æ•—: ${JSON.stringify(error)}`);
        }
    }
}
```

### 2. `src/server.ts` - æ”¹é€²éŒ¯èª¤è™•ç†

**ä¿®æ­£**ï¼šæä¾›æ›´è©³ç´°çš„éŒ¯èª¤è¨Šæ¯

```typescript
} catch (error: any) {
    console.error('è™•ç†è«‹æ±‚æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
    console.error('éŒ¯èª¤å †ç–Š:', error.stack);
    
    // æä¾›æ›´è©³ç´°çš„éŒ¯èª¤è¨Šæ¯
    let errorMessage = 'ä¼ºæœå™¨å…§éƒ¨éŒ¯èª¤';
    if (error.message) {
        errorMessage = error.message;
    } else if (typeof error === 'string') {
        errorMessage = error;
    } else if (error.error) {
        errorMessage = error.error;
    }
    
    // è¨˜éŒ„å®Œæ•´çš„éŒ¯èª¤è³‡è¨Š
    console.error('éŒ¯èª¤è©³æƒ…:', {
        message: errorMessage,
        name: error.name,
        stack: error.stack,
        code: error.code,
        statusCode: error.statusCode
    });
    
    res.status(500).json({
        success: false,
        error: errorMessage
    } as StudentGradeResponse);
}
```

### 3. `src/excel.ts` - æ”¹é€² Excel è™•ç†éŒ¯èª¤

**ä¿®æ­£**ï¼šæä¾›æ›´è©³ç´°çš„éŒ¯èª¤è¨Šæ¯

```typescript
} catch (error: any) {
    console.error('ä¸‹è¼‰ Excel æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
    console.error('éŒ¯èª¤è©³æƒ…:', {
        message: error?.message,
        name: error?.name,
        stack: error?.stack,
        code: error?.code,
        statusCode: error?.statusCode
    });
    
    // æä¾›æ›´è©³ç´°çš„éŒ¯èª¤è¨Šæ¯
    if (error?.message) {
        throw new Error(`Excel æª”æ¡ˆè™•ç†éŒ¯èª¤: ${error.message}`);
    } else if (typeof error === 'string') {
        throw new Error(`Excel æª”æ¡ˆè™•ç†éŒ¯èª¤: ${error}`);
    } else {
        throw new Error(`Excel æª”æ¡ˆè™•ç†éŒ¯èª¤: ${JSON.stringify(error)}`);
    }
}
```

## ğŸš€ éƒ¨ç½²æ­¥é©Ÿ

### æ­¥é©Ÿ 1ï¼šæ›´æ–°ä»£ç¢¼

ç¢ºä¿ä»¥ä¸‹æª”æ¡ˆå·²æ›´æ–°ï¼š
- âœ… `src/auth.ts` - èªè­‰ scope ä¿®æ­£
- âœ… `src/server.ts` - éŒ¯èª¤è™•ç†æ”¹é€²
- âœ… `src/excel.ts` - Excel è™•ç†éŒ¯èª¤æ”¹é€²

### æ­¥é©Ÿ 2ï¼šé‡æ–°å»ºç½®ä¸¦éƒ¨ç½²

```bash
# åœ¨ railway-proxy-server ç›®éŒ„ä¸­
npm install
npm run build
# Railway æœƒè‡ªå‹•éƒ¨ç½²
```

### æ­¥é©Ÿ 3ï¼šæª¢æŸ¥ Railway æ—¥èªŒ

éƒ¨ç½²å¾Œï¼Œæª¢æŸ¥ Railway æ—¥èªŒä»¥ç¢ºèªï¼š
1. æœå‹™æ˜¯å¦æ­£å¸¸å•Ÿå‹•
2. èªè­‰é¡å‹æ˜¯å¦æ­£ç¢ºè­˜åˆ¥
3. Scope æ˜¯å¦æ­£ç¢ºè¨­å®š

## ğŸ” è¨ºæ–·æ­¥é©Ÿ

### 1. æª¢æŸ¥ Railway æ—¥èªŒ

åœ¨ Railway æ§åˆ¶å°ä¸­æŸ¥çœ‹æ—¥èªŒï¼Œå°‹æ‰¾ï¼š
- `ä½¿ç”¨ Client Secret èªè­‰` æˆ– `ä½¿ç”¨ UsernamePasswordCredential èªè­‰`
- `å–å¾—å­˜å–æ¬Šæ–ï¼Œèªè­‰é¡å‹: ...`
- `Scope: ...`
- ä»»ä½•éŒ¯èª¤è¨Šæ¯

### 2. æ¸¬è©¦å¥åº·æª¢æŸ¥ç«¯é»

```bash
curl https://railway-proxy-server-production.up.railway.app/health
```

æ‡‰è©²è¿”å›ï¼š
```json
{
  "status": "ok",
  "timestamp": "...",
  "service": "Student Grade Proxy Server"
}
```

### 3. æª¢æŸ¥ç’°å¢ƒè®Šæ•¸

ç¢ºèª Railway ç’°å¢ƒè®Šæ•¸å·²æ­£ç¢ºè¨­å®šï¼š
- `TENANT_ID`
- `CLIENT_ID`
- `CLIENT_SECRET` æˆ– `PROXY_USERNAME` + `PROXY_PASSWORD`

### 4. æ¸¬è©¦ API ç«¯é»

```bash
curl -X POST https://railway-proxy-server-production.up.railway.app/api/getStudentGrade \
  -H "Content-Type: application/json" \
  -d '{
    "studentId": "test123",
    "excelFilePath": "https://groupespauloedu.sharepoint.com/:x:/r/sites/Classrooms/Shared%20Documents/test.xlsx"
  }'
```

## ğŸ“ å¸¸è¦‹éŒ¯èª¤èˆ‡è§£æ±ºæ–¹æ¡ˆ

### éŒ¯èª¤ 1: `AADSTS1002012: The provided value for scope ... is not valid`

**åŸå› **ï¼šä½¿ç”¨ `ClientSecretCredential` æ™‚ï¼Œscope æ ¼å¼ä¸æ­£ç¢º

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
- ç¢ºä¿ä½¿ç”¨ `['https://graph.microsoft.com/.default']` è€Œä¸æ˜¯å…·é«”çš„æ¬Šé™ç¯„åœ
- æª¢æŸ¥ `isClientSecretAuth` æ¨™è¨˜æ˜¯å¦æ­£ç¢ºè¨­å®š

### éŒ¯èª¤ 2: `èªè­‰å¤±æ•—: ...`

**åŸå› **ï¼šèªè­‰è³‡è¨Šä¸æ­£ç¢ºæˆ–ç’°å¢ƒè®Šæ•¸æœªè¨­å®š

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
- æª¢æŸ¥ `CLIENT_SECRET` æˆ– `PROXY_USERNAME`/`PROXY_PASSWORD` æ˜¯å¦æ­£ç¢º
- ç¢ºèª Azure AD æ‡‰ç”¨ç¨‹å¼è¨­å®šæ­£ç¢º
- ç¢ºèªæ‡‰ç”¨ç¨‹å¼å·²æˆäºˆå¿…è¦çš„ API æ¬Šé™

### éŒ¯èª¤ 3: `Excel æª”æ¡ˆè™•ç†éŒ¯èª¤: ...`

**åŸå› **ï¼šExcel æª”æ¡ˆè·¯å¾‘æ ¼å¼ä¸æ­£ç¢ºæˆ–æ¬Šé™ä¸è¶³

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
- ç¢ºèª Excel æª”æ¡ˆè·¯å¾‘æ ¼å¼æ­£ç¢º
- ç¢ºèªæ‡‰ç”¨ç¨‹å¼æœ‰ `Files.Read.All` å’Œ `Sites.Read.All` æ¬Šé™
- ç¢ºèªæ‡‰ç”¨ç¨‹å¼å·²æˆäºˆç®¡ç†å“¡åŒæ„

## ğŸ”— ç›¸é—œæª”æ¡ˆ

- `src/auth.ts` - èªè­‰æä¾›è€…
- `src/server.ts` - Express ä¼ºæœå™¨
- `src/excel.ts` - Excel æª”æ¡ˆè™•ç†
- `src/types.ts` - é¡å‹å®šç¾©

## ğŸ“ éœ€è¦å”åŠ©ï¼Ÿ

å¦‚æœå•é¡ŒæŒçºŒå­˜åœ¨ï¼Œè«‹æä¾›ï¼š
1. Railway æ—¥èªŒçš„å®Œæ•´éŒ¯èª¤è¨Šæ¯
2. æ¸¬è©¦è«‹æ±‚çš„å®Œæ•´å›æ‡‰
3. ç’°å¢ƒè®Šæ•¸è¨­å®šï¼ˆéš±è—æ•æ„Ÿè³‡è¨Šï¼‰
