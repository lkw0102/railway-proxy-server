# 授予 Azure AD 應用程式管理員同意

## 🔴 問題

當使用 `UsernamePasswordCredential`（委派認證）時，出現以下錯誤：

```
AADSTS65001: The user or administrator has not consented to use the application with ID '43f7cb09-1365-4381-90f9-1c8ee1112422' named 'Student Grade Proxy Server (Railway)'. Send an interactive authorization request for this user and resource.
```

這表示應用程式需要管理員或使用者同意授權。

## ✅ 解決方案：授予管理員同意

### 方法 1：透過 Azure Portal（推薦）

1. **登入 Azure Portal**
   - 前往：https://portal.azure.com
   - 使用管理員帳號登入

2. **進入 Azure Active Directory**
   - 在左側選單中點擊 **Azure Active Directory**
   - 或直接搜尋 "Azure Active Directory"

3. **進入應用程式註冊**
   - 在左側選單中點擊 **應用程式註冊**
   - 或直接搜尋 "應用程式註冊"

4. **選擇應用程式**
   - 找到並點擊應用程式：**Student Grade Proxy Server (Railway)**
   - 或使用應用程式 ID：`43f7cb09-1365-4381-90f9-1c8ee1112422`

5. **授予 API 權限**
   - 在左側選單中點擊 **API 權限**
   - 確認以下權限已新增：
     - ✅ `Files.Read.All` (Microsoft Graph) - 委派權限
     - ✅ `Sites.Read.All` (Microsoft Graph) - 委派權限

6. **授予管理員同意**
   - 點擊 **為 [租用戶名稱] 授予管理員同意** 按鈕
   - 確認對話框中點擊 **是**

7. **確認狀態**
   - 確認權限狀態顯示為 **已授與**（綠色勾選標記）

### 方法 2：透過 URL（快速）

直接訪問以下 URL（替換 `{TENANT_ID}` 和 `{CLIENT_ID}`）：

```
https://login.microsoftonline.com/{TENANT_ID}/adminconsent?client_id={CLIENT_ID}
```

**實際 URL**（使用你的值）：
```
https://login.microsoftonline.com/d1a86d43-9bb5-40b7-ab52-754d8d6d7bf1/adminconsent?client_id=43f7cb09-1365-4381-90f9-1c8ee1112422
```

1. 使用管理員帳號登入
2. 檢閱權限請求
3. 點擊 **接受** 或 **同意**

### 方法 3：使用 PowerShell（進階）

```powershell
# 連線到 Azure AD
Connect-AzureAD

# 授予管理員同意
$appId = "43f7cb09-1365-4381-90f9-1c8ee1112422"
$resourceId = "00000003-0000-0000-c000-000000000000" # Microsoft Graph

# 取得服務主體
$sp = Get-AzureADServicePrincipal -Filter "appId eq '$appId'"
$graphSp = Get-AzureADServicePrincipal -Filter "appId eq '$resourceId'"

# 授予權限
$permissions = @(
    "df021288-bdef-4463-88db-98f22de89214", # Files.Read.All
    "75359482-378d-4052-8f07-770ba3eed3b0"  # Sites.Read.All
)

foreach ($permission in $permissions) {
    $appPermission = $graphSp.AppRoles | Where-Object { $_.Id -eq $permission }
    if ($appPermission) {
        New-AzureADServiceAppRoleAssignment -ObjectId $sp.ObjectId -PrincipalId $sp.ObjectId -ResourceId $graphSp.ObjectId -Id $appPermission.Id
    }
}
```

## 📋 確認步驟

完成後，確認以下事項：

1. ✅ **API 權限已授與**
   - 在 Azure Portal 中確認權限狀態為 **已授與**

2. ✅ **測試認證**
   - 等待幾分鐘讓變更生效
   - 重新測試代理服務

3. ✅ **檢查日誌**
   - 查看 Railway 日誌，確認不再出現 `AADSTS65001` 錯誤

## ⚠️ 注意事項

- **管理員權限**：授予管理員同意需要 Azure AD 全域管理員或應用程式管理員權限
- **生效時間**：變更可能需要幾分鐘才能生效
- **權限範圍**：管理員同意會為整個租用戶授予權限，所有使用者都可以使用此應用程式

## 🔍 驗證

完成後，可以透過以下方式驗證：

1. **檢查 Azure Portal**
   - 進入應用程式 → API 權限
   - 確認權限狀態為 **已授與**

2. **測試 API**
   - 重新測試代理服務 URL
   - 應該可以成功讀取 Excel 檔案

## 📞 如果仍有問題

如果授予管理員同意後仍有問題，請檢查：

1. **應用程式是否設定為公開客戶端**
   - 進入應用程式 → 驗證
   - 確認 **允許公開客戶端流程** 設定為 **是**

2. **權限是否正確**
   - 確認 `Files.Read.All` 和 `Sites.Read.All` 都是 **委派權限**（不是應用程式權限）

3. **使用者帳號權限**
   - 確認 `PROXY_USERNAME` 對應的使用者帳號有權限存取 SharePoint 檔案
